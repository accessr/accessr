<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Accessr â€” Free Accessibility Checker & Fixer for Word (.docx)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="description" content="Accessr is a free, privacy-first accessibility checker for Microsoft Word .docx. Runs entirely in your browser â€” no uploads, no data collection." />
  <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 256 256'%3E%3Crect width='256' height='256' rx='48' fill='%230B1020'/%3E%3Cpath fill='%233B82F6' d='M48 176h96a40 40 0 0 0 0-80H96l24-24-16-16-56 56 56 56 16-16-24-24h48a24 24 0 1 1 0 48H48z'/%3E%3Ccircle cx='196' cy='92' r='10' fill='%2310B981'/%3E%3C/svg%3E" />
  <style>
    :root{
      --bg:#0b1020; --panel:#0f1622; --text:#eef4fb; --muted:#9fb0c2;
      --brand:#3B82F6; --accent:#10B981; --border:#1b2430;
      --ok:#34d399; --warn:#ffcc00; --err:#ff6b6b;
      --focus: 0 0 0 3px rgba(59,130,246,.45), 0 0 0 6px rgba(59,130,246,.2);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:linear-gradient(180deg,#09111b,#0b1020);color:var(--text);font:16px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,"Helvetica Neue",Arial}
    a{color:var(--brand)}
    a:focus,button:focus,input:focus,select:focus,summary:focus{outline:none;box-shadow:var(--focus);border-radius:8px}
    header{position:sticky;top:0;backdrop-filter:saturate(120%) blur(8px);background:rgba(11,16,32,.7);border-bottom:1px solid var(--border);z-index:10}
    .wrap{max-width:1120px;margin:0 auto;padding:0 20px}
    .nav{display:flex;align-items:center;gap:16px;padding:14px 0}
    .brand{display:flex;align-items:center;gap:10px;text-decoration:none;color:var(--text)}
    .brand svg{width:28px;height:28px}
    .brand strong{font-weight:700}
    .grow{flex:1}
    .btn{display:inline-flex;align-items:center;gap:8px;padding:10px 14px;border:1px solid var(--border);background:#121a26;color:var(--text);border-radius:10px;cursor:pointer;text-decoration:none}
    .btn:hover{background:#152030}
    .primary{background:linear-gradient(180deg,#10263a,#0f1e30);border-color:#1e3046}
    .primary:hover{background:linear-gradient(180deg,#14324d,#14283f)}
    .hero{padding:72px 0 28px;border-bottom:1px solid var(--border)}
    .hero h1{font-size:38px;line-height:1.1;margin:0 0 12px}
    .hero p{max-width:720px;color:var(--muted);margin:0}
    .chip{display:inline-flex;align-items:center;gap:6px;border:1px solid var(--border);border-radius:999px;padding:3px 8px;background:#0d141d;color:var(--muted);font-size:12px}
    .section{padding:28px 0}
    .grid{display:grid;gap:18px}
    @media (min-width:900px){ .grid-2{grid-template-columns:1.1fr .9fr;} .grid-3{grid-template-columns:repeat(3,1fr);} }
    .card{background:var(--panel);border:1px solid var(--border);border-radius:14px;padding:18px}
    h2{margin:0 0 12px;font-size:22px}
    .mini{font-size:13px;color:var(--muted)}
    .pill{display:inline-flex;align-items:center;gap:6px;padding:2px 8px;border-radius:999px;border:1px solid #273142;background:#0d141d}
    .ok{color:var(--ok)} .warn{color:var(--warn)} .err{color:var(--err)}
    details{background:#0c121a;border:1px solid #17202c;border-radius:12px;padding:12px}
    pre{background:#0b1017;border:1px solid #17202c;border-radius:8px;padding:12px;overflow:auto}
    footer{border-top:1px solid var(--border);padding:24px 0;color:var(--muted)}
    .drop{border:2px dashed #24405d;border-radius:14px;padding:16px;text-align:center;background:#0e1624}
    .drop.hover{background:#102338}
    .controls{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
    #file{display:block;margin:8px auto 0}
    .range{display:flex;gap:10px;align-items:center}
    input[type="number"], select{padding:8px 10px;border-radius:10px;border:1px solid #1b2430;background:#0c121a;color:var(--text)}
    .live{min-height:1.3em;margin-top:8px}
  </style>
</head>
<body>
  <header role="banner">
    <div class="wrap nav" aria-label="Site header">
      <a class="brand" href="#home" aria-label="Accessr Home">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 256 256" aria-hidden="true">
          <rect width="256" height="256" rx="48" fill="#0B1020"/>
          <path fill="#3B82F6" d="M48 176h96a40 40 0 0 0 0-80H96l24-24-16-16-56 56 56 56 16-16-24-24h48a24 24 0 1 1 0 48H48z"/>
          <circle cx="196" cy="92" r="10" fill="#10B981"/>
        </svg>
        <strong>Accessr</strong>
      </a>
      <div class="grow"></div>
      <a class="btn" href="#tool">Launch tool</a>
      <a class="btn" href="#faq">FAQ</a>
      <a class="btn primary" href="#privacy">Privacy</a>
    </div>
  </header>

  <section class="wrap hero" id="home">
    <span class="chip">Free â€¢ Runs in your browser â€¢ No uploads</span>
    <h1>Make your Word documents accessible â€” in minutes, not days.</h1>
    <p>Upload a <strong>.docx</strong>, run checks, auto-fix common issues, and download a cleaned file plus an audit report â€” all without your document ever leaving your device.</p>
    <div style="margin-top:16px;display:flex;gap:10px;flex-wrap:wrap">
      <a class="btn primary" href="#tool" aria-label="Jump to tool">Get started</a>
      <a class="btn" href="#how">How it works</a>
    </div>
  </section>

  <section class="wrap section grid grid-2" id="tool" aria-label="Accessibility tool">
    <div class="card" aria-labelledby="upload-h">
      <h2 id="upload-h">Check & Fix your .docx</h2>
      <p class="mini">Built for government, business, higher-ed, and community groups. No signup. No servers.</p>

      <div class="drop" id="drop" tabindex="0" role="region" aria-label="Drop zone â€” drop a .docx file here">
        <p><strong>Drag & drop</strong> your file here, or</p>
        <button id="chooseBtn" type="button" class="btn">Choose a file</button>
        <input id="file" type="file" accept=".docx" />
        <p class="mini" id="filename" aria-live="polite"></p>

        <div class="mini" style="display:grid;gap:8px;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));margin-top:10px">
          <label style="display:flex;gap:8px;align-items:center"><input id="fixImgAlt" type="checkbox" checked /> Fix: Add placeholder image alt</label>
          <label style="display:flex;gap:8px;align-items:center"><input id="fixTblHdr" type="checkbox" checked /> Fix: Mark first table row as header</label>
          <label style="display:flex;gap:8px;align-items:center"><input id="fixLang"   type="checkbox" checked /> Fix: Add run language if missing</label>
          <label style="display:flex;gap:8px;align-items:center"><input id="fixHead"   type="checkbox" /> Fix: Convert obvious fake headings â†’ Heading 2</label>
          <label style="display:flex;gap:8px;align-items:center"><input id="fixSize"   type="checkbox" /> Fix: Raise tiny font to minimum</label>
          <label style="display:flex;gap:8px;align-items:center"><input id="fixList"   type="checkbox" /> Fix: Convert fake bullets to real list style</label>
        </div>

        <div class="mini" style="display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin-top:10px">
          <label style="display:flex;gap:8px;align-items:center">
            <input id="safeTouch" type="checkbox" checked />
            <span>Use SafeTouch (recommended)</span>
          </label>
          <label style="display:flex;gap:8px;align-items:center">
            <input id="compat" type="checkbox" checked />
            <span>Compat: preserve namespaces/root (fxp mode)</span>
          </label>
        </div>
        <div id="debug" class="mini" style="margin-top:8px;display:none"></div>
      </div>

      <div class="controls" role="group" aria-label="Options">
        <div class="range">
          <label for="lang" class="mini">Default language</label>
          <select id="lang" aria-label="Default language for runs">
            <option value="en-AU">English (Australia)</option>
            <option value="en-GB">English (UK)</option>
            <option value="en-US">English (US)</option>
          </select>
        </div>
        <div class="range">
          <label for="minFont" class="mini">Min font (pt)</label>
          <input id="minFont" type="number" min="10" max="16" step="1" value="11" />
        </div>
      </div>

      <div class="controls">
        <button id="runBtn" class="btn primary" disabled aria-disabled="true">Run checks</button>
        <a id="dlFixed" class="btn" style="display:none" download>Download fixed .docx</a>
        <a id="dlReport" class="btn" style="display:none" download>Download report.md</a>
      </div>
      <div id="status" class="live" aria-live="polite"></div>

      <div id="diag" class="mini" style="margin-top:10px; border:1px solid #1b2430; border-radius:10px; padding:10px; background:#0c121a; display:none">
        <div><strong>Diagnostics</strong></div>
        <div id="diagLib">â€¢ Libraries: <em>checkingâ€¦</em></div>
        <div id="diagFile">â€¢ File: <em>none selected</em></div>
        <div id="diagReady">â€¢ Ready: <em>no</em></div>
        <div id="diagErr" style="color:#ff6b6b; margin-top:6px;"></div>
      </div>
    </div>

    <div class="card" aria-labelledby="results-h">
      <h2 id="results-h">Results</h2>
      <div id="summary" class="mini" style="margin-bottom:8px"></div>
      <details>
        <summary>Show raw report (Markdown)</summary>
        <pre id="rawReport"></pre>
      </details>
      <div style="margin-top:12px">
        <span class="pill"><span class="ok">âœ…</span> Fixed</span>
        <span class="pill"><span class="warn">â€¢</span> Needs review</span>
      </div>
    </div>
  </section>

  <!-- Early safety wiring -->
  <script>
  (function(){
    const chooseBtn = document.getElementById('chooseBtn');
    const fileInput = document.getElementById('file');
    const filenameEl = document.getElementById('filename');
    const runBtn = document.getElementById('runBtn');
    const diagWrap  = document.getElementById('diag');
    const diagFile  = document.getElementById('diagFile');
    const diagReady = document.getElementById('diagReady');
    const debugEl = document.getElementById('debug');

    function dbg(msg){ if(!debugEl) return; debugEl.style.display='block'; debugEl.textContent=String(msg); }
    function setDiagFile(text){ if(diagWrap) diagWrap.style.display='block'; if(diagFile) diagFile.innerHTML='â€¢ File: ' + text; }
    function setDiagReady(ok){ if(diagWrap) diagWrap.style.display='block'; if(diagReady) diagReady.innerHTML='â€¢ Ready: ' + (ok?'<span style="color:#34d399">yes</span>':'<span style="color:#ffcc00">no</span>'); }

    function onPick(f){
      window.__accessrSelectedFile = f || null;
      if (filenameEl) filenameEl.textContent = f ? ('Selected file: ' + (f.name||'')) : '';
      if (runBtn) { runBtn.disabled = !f; runBtn.setAttribute('aria-disabled', String(!f)); }
      if (f){
        dbg('Picked: ' + (f.name||'(no name)') + ' â€¢ type=' + (f.type||'(blank)') + ' â€¢ size=' + (f.size||0) + ' bytes');
        setDiagFile('<span style="color:#34d399">' + f.name + '</span> (' + (f.type||'') + ', ' + (f.size||0) + ' bytes)');
        setDiagReady(true);
      } else { setDiagFile('<em>none selected</em>'); setDiagReady(false); }
    }

    if (chooseBtn && fileInput){
      chooseBtn.addEventListener('click', function(){ try{ fileInput.click(); }catch(e){} });
      fileInput.addEventListener('change', function(){ onPick((fileInput.files && fileInput.files[0]) || null); });
    }
  })();
  </script>

  <!-- Local libraries -->
  <script src="./vendor/jszip.min.js"></script>
  <script src="./vendor/fxp.min.js"></script>
  <script src="./vendor/FileSaver.min.js"></script>
  <script>
    (function(){
      const hasFxpNS = !!(window.fxp && window.fxp.XMLParser && window.fxp.XMLBuilder);
      const hasGlobal = !!(window.XMLParser && window.XMLBuilder);
      const ok = !!window.JSZip && !!(hasFxpNS || hasGlobal) && !!window.saveAs;
      window.__XMLParserCtor  = hasFxpNS ? window.fxp.XMLParser  : (hasGlobal ? window.XMLParser  : null);
      window.__XMLBuilderCtor = hasFxpNS ? window.fxp.XMLBuilder : (hasGlobal ? window.XMLBuilder : null);
      const diag = document.getElementById('diag'), diagLib = document.getElementById('diagLib');
      if (diag) diag.style.display = 'block';
      if (diagLib) {
        diagLib.innerHTML = ok
          ? 'â€¢ Libraries: <span style="color:#34d399">OK (local)</span> â€” (local)'
          : 'â€¢ Libraries: <span style="color:#ff6b6b">Missing /vendor files (jszip.min.js, fxp.min.js, FileSaver.min.js)</span>';
      }
    })();
  </script>

  <!-- App -->
  <script>
    document.getElementById('year') && (document.getElementById('year').textContent = new Date().getFullYear());

    // ---- utils shared ----
    function ensureArray(x){ return Array.isArray(x) ? x : (x == null ? [] : [x]); }

    // ---- report helper ----
    function makeReport(fileName){
      return {
        file: fileName || '(untitled)',
        issues: [],
        add(code, message, location, fixed, details){
          this.issues.push({ code:String(code||'INFO'), message:String(message||''), location:String(location||'Document'), fix_applied:!!fixed, details:details||{} });
        },
        toMarkdown(){
          if(!this.issues.length) return '# Accessibility Report for `'+this.file+'`\n\nðŸŽ‰ No issues found.\n';
          const lines = ['# Accessibility Report for `'+this.file+'`',''];
          for (const it of this.issues){
            let line = `- **[${it.code}]** ${it.message} â€” *${it.location}* (${it.fix_applied ? 'âœ… fixed' : 'âš  needs review'})`;
            if (it.details && Object.keys(it.details).length) line += `\n  - details: \`${JSON.stringify(it.details)}\``;
            lines.push(line);
          }
          return lines.join('\n');
        },
        counts(){ const t=this.issues.length,f=this.issues.filter(i=>i.fix_applied).length; return { total:t,fixed:f,flagged:t-f }; }
      };
    }

    // ---- SafeTouch: DOM-based minimal edits (no reformatting) ----
    function xmlToDom(xml){
      const dom = new DOMParser().parseFromString(xml, 'application/xml');
      const err = dom.querySelector('parsererror');
      if (err) throw new Error('XML parse error');
      return dom;
    }
    function domToXml(dom){
      return (new XMLSerializer()).serializeToString(dom);
    }

    function safeTouch_documentXml(xml, opts, report){
      const dom = xmlToDom(xml);
      const wns = 'http://schemas.openxmlformats.org/wordprocessingml/2006/main';
      const wps = 'http://schemas.openxmlformats.org/drawingml/2006/wordprocessingDrawing';
      // 1) Images: add alt on wp:docPr if missing descr
      if (opts.fixes.imgAlt){
        const docPrs = dom.getElementsByTagNameNS(wps, 'docPr');
        let added=0, total=docPrs.length;
        for (let i=0;i<docPrs.length;i++){
          const n = docPrs[i];
          const descr = n.getAttribute('descr');
          if (!descr || !descr.trim()){
            n.setAttribute('descr','IMAGE â€“ add descriptive alt text');
            added++;
          }
        }
        if (total>0){
          if (added>0) report.add('IMG-ALT->FIX',`Added placeholder alt text to ${added} of ${total} image(s).`,'Document',true);
          else report.add('IMG-ALT','All images already have alt text.','Document',false);
        }
      }
      // 2) Tables: mark first row as header if obvious
      if (opts.fixes.tblHeader){
        const tbls = dom.getElementsByTagNameNS(wns,'tbl');
        let fixed=0;
        for (let t=0;t<tbls.length;t++){
          const tbl = tbls[t];
          const rows = tbl.getElementsByTagNameNS(wns,'tr');
          if (!rows.length) continue;
          const first = rows[0];
          // heuristic: short-ish text in many cells
          const cells = first.getElementsByTagNameNS(wns,'tc');
          if (!cells.length) continue;
          let hits=0;
          for (let c=0;c<cells.length;c++){
            const cell = cells[c];
            const texts = Array.from(cell.getElementsByTagNameNS(wns,'t')).map(n=>n.textContent||'').join(' ').trim();
            if (!texts) continue;
            if (texts.length<=25) hits++;
            if (/^[A-Z\s0-9]+$/.test(texts)) hits++;
            if (/^[A-Z][a-z]+(\s[A-Z][a-z]+)*$/.test(texts)) hits++;
          }
          if (hits >= Math.max(1, Math.floor(cells.length/2))){
            // add <w:tblHeader w:val="true"/> in first row's trPr if not present
            let trPr = first.getElementsByTagNameNS(wns,'trPr')[0];
            if (!trPr){ trPr = dom.createElementNS(wns,'w:trPr'); first.insertBefore(trPr, first.firstChild); }
            if (!trPr.getElementsByTagNameNS(wns,'tblHeader')[0]){
              const th = dom.createElementNS(wns,'w:tblHeader');
              th.setAttributeNS(wns,'w:val','true');
              trPr.appendChild(th);
              fixed++;
            }
          }
        }
        if (fixed>0) report.add('TBL-HEADER->FIX',`Marked first row as a repeating header in ${fixed} table(s).`,'Document',true);
      }
      // 3) Runs: add w:lang where missing
      if (opts.fixes.lang){
        const runs = dom.getElementsByTagNameNS(wns,'r');
        let set=0;
        for (let i=0;i<runs.length;i++){
          const r = runs[i];
          let rPr = r.getElementsByTagNameNS(wns,'rPr')[0];
          if (!rPr){ rPr = dom.createElementNS(wns,'w:rPr'); r.insertBefore(rPr, r.firstChild); }
          let lang = rPr.getElementsByTagNameNS(wns,'lang')[0];
          let has = lang && (lang.getAttributeNS(wns,'val') || lang.getAttribute('w:val') || lang.getAttribute('val'));
          if (!has){
            if (!lang){ lang = dom.createElementNS(wns,'w:lang'); rPr.appendChild(lang); }
            lang.setAttributeNS(wns,'w:val', opts.lang);
            lang.setAttributeNS(wns,'w:eastAsia', opts.lang);
            lang.setAttributeNS(wns,'w:bidi', opts.lang);
            set++;
          }
        }
        if (set>0) report.add('DOC-LANG->FIX',`Set language to ${opts.lang} on ${set} run(s).`,'Document',true);
      }
      return domToXml(dom); // DOMSerializer preserves prefixes and avoids reflowing unrelated nodes
    }

    // ---- FXP mode (legacy, for advanced conversions) ----
    let parser = null, builder = null, __rawXmlByPart = Object.create(null);
    function graftRootTag(originalXml, rebuiltXml){
      function firstStartTag(xml){
        let i = xml.indexOf('<'); if (i < 0) return null;
        if (xml.slice(i, i+5).toLowerCase() === '<?xml'){
          const q = xml.indexOf('?>', i); if (q < 0) return null;
          i = xml.indexOf('<', q + 2); if (i < 0) return null;
        }
        const j = xml.indexOf('>', i); if (j < 0) return null;
        return { start: i, end: j + 1, text: xml.slice(i, j + 1) };
      }
      const orig = firstStartTag(originalXml); const newer = firstStartTag(rebuiltXml);
      if (!orig || !newer) return rebuiltXml;
      return rebuiltXml.slice(0, newer.start) + orig.text + rebuiltXml.slice(newer.end);
    }
    async function readXml(zip, name){ const xml = await zip.files[name].async('string'); __rawXmlByPart[name] = xml; return parser.parse(xml); }
    function writeXml(zip, name, obj, opts){
      let xmlStr = builder.build(obj);
      if (!xmlStr.startsWith('<?xml')) xmlStr = '<?xml version="1.0" encoding="UTF-8" standalone="yes"?>\n' + xmlStr;
      if (opts && opts.compat && __rawXmlByPart[name]) xmlStr = graftRootTag(__rawXmlByPart[name], xmlStr);
      zip.file(name, xmlStr);
    }
    function listWordXmlParts(zip){
      const out=[]; for (const n of Object.keys(zip.files)){
        if(/^word\/document\.xml$/.test(n)) out.push(n);
        if(/^word\/header\d+\.xml$/.test(n)) out.push(n);
        if(/^word\/footer\d+\.xml$/.test(n)) out.push(n);
      } return out;
    }

    // ---- Process orchestrator ----
    async function processFile(file, opts){
      const buffer = await file.arrayBuffer();
      const zip = await JSZip.loadAsync(buffer);
      const parts = listWordXmlParts(zip);
      if(!parts.length) throw new Error('No Word XML parts found in document.');
      const report = makeReport(file.name);

      if (opts.safeTouch){
        // Only touch minimal things via DOM; leave structure intact
        for (const name of parts){
          const xml = await zip.files[name].async('string');
          const updated = safeTouch_documentXml(xml, opts, report);
          if (updated && updated !== xml){
            zip.file(name, updated);
          }
        }
      } else {
        // FXP mode (optional, more invasive). Only enable the toggles you really want.
        const XMLParserCtor  = window.__XMLParserCtor;
        const XMLBuilderCtor = window.__XMLBuilderCtor;
        if (!XMLParserCtor || !XMLBuilderCtor) throw new Error('FXP libraries not available');
        const compatOn = !!opts.compat;
        parser = new XMLParserCtor({ ignoreAttributes:false, attributeNamePrefix:'', removeNSPrefix: !compatOn ? true : false });
        builder = new XMLBuilderCtor({ ignoreAttributes:false, attributeNamePrefix:'', format:true });

        // Only the conservative pieces here to minimise formatting shifts
        for (const name of parts){
          const js = await readXml(zip, name);
          // Minimal JS walk for counts (optional): we rely on SafeTouch for actual edits in default flow.
          // If you later enable fxp-only edits, wire them here.
          writeXml(zip, name, js, { compat: opts.compat });
        }
      }

      // Package outputs
      const content = await zip.generateAsync({ type:'blob' });
      const fixedBlob = new Blob([content], { type:'application/vnd.openxmlformats-officedocument.wordprocessingml.document' });
      const md = report.toMarkdown();
      const reportBlob = new Blob([md], { type: 'text/markdown;charset=utf-8' });
      return { report, fixedBlob, reportBlob };
    }

    // ---- UI wiring ----
    (function(){
      const drop=document.getElementById('drop');
      const fileInput=document.getElementById('file');
      const chooseBtn=document.getElementById('chooseBtn');
      const runBtn=document.getElementById('runBtn');
      const dlFixed=document.getElementById('dlFixed');
      const dlReport=document.getElementById('dlReport');
      const rawReport=document.getElementById('rawReport');
      const statusEl=document.getElementById('status');
      const filename=document.getElementById('filename');
      const summary=document.getElementById('summary');
      const langSel=document.getElementById('lang');
      const minFont=document.getElementById('minFont');
      const compat=document.getElementById('compat');
      const safeTouch=document.getElementById('safeTouch');
      const fixImgAlt=document.getElementById('fixImgAlt');
      const fixTblHdr=document.getElementById('fixTblHdr');
      const fixLang=document.getElementById('fixLang');
      const fixHead=document.getElementById('fixHead'); // only in fxp mode (advanced)
      const fixSize=document.getElementById('fixSize'); // only in fxp mode (advanced)
      const fixList=document.getElementById('fixList'); // only in fxp mode (advanced)
      const diagWrap=document.getElementById('diag');
      const diagLib=document.getElementById('diagLib');
      const diagFile=document.getElementById('diagFile');
      const diagReady=document.getElementById('diagReady');
      const diagErr=document.getElementById('diagErr');

      let currentFile=null;

      function showDiag(){ if(diagWrap) diagWrap.style.display='block'; }
      function setDiagLib(ok,msg){ showDiag(); if(!diagLib) return; diagLib.innerHTML='â€¢ Libraries: '+(ok?'<span style="color:#34d399">OK (local)</span>':'<span style="color:#ff6b6b">Missing</span>')+(msg?' â€” '+msg:''); }
      function setDiagFile(text){ showDiag(); if(diagFile) diagFile.innerHTML='â€¢ File: '+text; }
      function setDiagReady(ok){ showDiag(); if(diagReady) diagReady.innerHTML='â€¢ Ready: '+(ok?'<span style="color:#34d399">yes</span>':'<span style="color:#ffcc00">no</span>'); }
      function setDiagErr(text){ showDiag(); if(diagErr) diagErr.textContent=text||''; }

      function looksLikeDocx(f){ if(!f) return false; const nameOk=/\.docx$/i.test(f.name||''); const mimeOk=(f.type||'').indexOf('officedocument.wordprocessingml.document')!==-1; return nameOk || mimeOk; }

      function setFile(f){
        currentFile=f;
        runBtn.disabled=!currentFile;
        runBtn.setAttribute('aria-disabled', String(!currentFile));
        filename.textContent=currentFile?('Selected file: '+currentFile.name):'';
        statusEl.textContent=currentFile?'Ready to process.':'';
        dlFixed.style.display='none'; dlReport.style.display='none';
        rawReport.textContent=''; summary.textContent='';
        setDiagFile(currentFile?('<span style="color:#34d399">'+currentFile.name+'</span> ('+(currentFile.type||'')+', '+(currentFile.size||0)+' bytes)'):'<em>none selected</em>');
        setDiagReady(!!currentFile);
      }

      (function adoptEarlyPick(){
        const early = window.__accessrSelectedFile;
        const fi = document.getElementById('file');
        const f = early || (fi && fi.files && fi.files[0]) || null;
        if (f) setFile(f);
      })();

      setDiagLib(!!window.JSZip && !!(window.__XMLParserCtor && window.__XMLBuilderCtor), '(local)');

      if (chooseBtn && fileInput) chooseBtn.addEventListener('click', function(){ try{ fileInput.click(); }catch(e){} });
      fileInput.addEventListener('change', function(){
        const f=(fileInput.files && fileInput.files[0])||null;
        if(!f){ setFile(null); return; }
        if(!looksLikeDocx(f)){ setFile(null); statusEl.innerHTML="<span class='err'>Please choose a Microsoft Word (.docx) file.</span>"; return; }
        setFile(f);
      });
      ['dragenter','dragover'].forEach(evt=> drop.addEventListener(evt, e=>{ e.preventDefault(); e.stopPropagation(); drop.classList.add('hover'); }));
      ['dragleave','drop'].forEach(evt=> drop.addEventListener(evt, e=>{ e.preventDefault(); e.stopPropagation(); drop.classList.remove('hover'); }));
      drop.addEventListener('drop', e=>{
        const f=e.dataTransfer && e.dataTransfer.files && e.dataTransfer.files[0];
        if(!f) return;
        if(!looksLikeDocx(f)){ statusEl.innerHTML="<span class='err'>Please drop a Word (.docx) file.</span>"; return; }
        setFile(f);
      });
      // click guard: only background or button triggers picker
      drop.addEventListener('click', function(e){
        const isBackground = e.target === drop;
        const isChooseBtn  = e.target && (e.target.id === 'chooseBtn');
        if (isBackground || isChooseBtn) fileInput.click();
      });
      Array.from(drop.querySelectorAll('input, label, select, button')).forEach(el=>{
        el.addEventListener('click', e => e.stopPropagation());
      });

      window.addEventListener('error', e=> setDiagErr('Script error: '+(e.message||'')));
      window.addEventListener('unhandledrejection', e=> setDiagErr('Unhandled promise: '+(e.reason && e.reason.message ? e.reason.message : String(e.reason || ''))));

      runBtn.addEventListener('click', async function(){
        setDiagErr('');
        if(!currentFile){ statusEl.innerHTML="<span class='err'>No file selected.</span>"; return; }

        runBtn.disabled=true; runBtn.setAttribute('aria-disabled','true');
        statusEl.textContent='Processingâ€¦ (all on your device)';
        dlFixed.style.display='none'; dlReport.style.display='none';
        rawReport.textContent=''; summary.textContent='';

        try{
          const opts = {
            safeTouch: !!(safeTouch && safeTouch.checked),
            compat: !!(compat && compat.checked),
            lang: (document.getElementById('lang').value || 'en-AU'),
            minFontPt: Number(minFont.value || 11),
            fixes: {
              imgAlt: !!(fixImgAlt && fixImgAlt.checked),
              tblHeader: !!(fixTblHdr && fixTblHdr.checked),
              lang: !!(fixLang && fixLang.checked),
              // the three below are fxp-only (leave off in SafeTouch)
              headings: !!(fixHead && fixHead.checked),
              fontSize: !!(fixSize && fixSize.checked),
              list: !!(fixList && fixList.checked),
            }
          };

          const { report, fixedBlob, reportBlob } = await processFile(currentFile, opts);
          const counts=report.counts();
          summary.innerHTML =
            '<span class="pill"><span class="warn">âš </span> Total: '+counts.total+'</span> '+
            '<span class="pill"><span class="ok">âœ…</span> Fixed: '+counts.fixed+'</span> '+
            '<span class="pill"><span class="warn">â€¢</span> Needs review: '+counts.flagged+'</span>';

          rawReport.textContent=report.toMarkdown();

          const ts=new Date().toISOString().slice(0,19).replace(/[:T]/g,'-');
          const base=currentFile.name.replace(/\.docx$/i,'')||'document';

          if(reportBlob){
            const url1=URL.createObjectURL(reportBlob);
            dlReport.href=url1; dlReport.download=base+'.a11y-report-'+ts+'.md'; dlReport.style.display='inline-flex';
          }
          if(fixedBlob){
            const url2=URL.createObjectURL(fixedBlob);
            dlFixed.href=url2; dlFixed.download=base+'.fixed-'+ts+'.docx'; dlFixed.style.display='inline-flex';
          }

          statusEl.textContent='Done. Download your fixed document and report below.';
        }catch(err){
          console.error(err);
          setDiagErr(err && err.message ? err.message : String(err));
          statusEl.innerHTML="<span class='err'>Error:</span> "+(err && err.message ? err.message : String(err));
        }finally{
          runBtn.disabled=!currentFile; runBtn.setAttribute('aria-disabled', String(!currentFile));
        }
      });
    })();
  </script>

  <footer role="contentinfo">
    <div class="wrap">
      <div>Â© <span id="year"></span> Accessr</div>
      <div class="mini">Free, client-side accessibility checker for Word documents.</div>
    </div>
  </footer>
</body>
</html>
